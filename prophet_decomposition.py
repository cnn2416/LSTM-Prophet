#!/usr/bin/env python
# -*- coding: utf-8 -*-

import numpy as np
import matplotlib.pyplot as plt
import xlrd
# import pywt
# import pywt.data
import re
import pandas as pd
from pylab import *
# from scipy import stats
import os
import scipy.interpolate as spi

from fbprophet.plot import add_changepoints_to_plot
from fbprophet import Prophet
dir_path='..\JCK08\\'
dir=os.listdir(dir_path)
num=len(dir)
mark=['.',',','o','v','^','<','>','1','2','3','4','s','p','*','h','H','+','x','D','d','|','_' ]
print(num)
mpl.rcParams["font.sans-serif"] = ["SimHei"]

matplotlib.rcParams['axes.unicode_minus']=False
water_dir='..\everyday\water_level_everyday-correct.xlsx'
rain_dir="..\everyday\precipitation_everyday.xlsx"
data_water=pd.read_excel(water_dir,index_col=0,engine='openpyxl')
data_rain=pd.read_excel(rain_dir,index_col=0,engine='openpyxl')

print(data_water.index)
plt.plot(data_water.index, data_water["underwater level"])
plt.plot(data_rain.index, data_rain['rainfall'])
plt.show()
for name in dir:
    if name == 'date14.xlsx':
        print(name)
        filename=dir_path+name
        data=pd.read_excel(filename,engine='openpyxl')
        # data=data[0:-500]

        # df=pd.DataFrame([])
        # print(data)
        df = pd.DataFrame(columns=['ds', 'y'])
        df['ds']=data[:]['Unnamed: 0']
        df['y']=data[:]['displacement']
        # m = Prophet(changepoint_prior_scale=0.5,n_changepoints=30,changepoint_range=0.8, growth = "logistic")
        m = Prophet()
        m.fit(df)
        # test
        df_test = pd.DataFrame(columns=['ds', 'y'])
        df_test['ds'] = data[:]['Unnamed: 0']
        df_test['y'] = data[:]['displacement']

        future = m.make_future_dataframe(periods = 0, freq = 'd')
        # print(11, future)
        forecast = m.predict(future)

        # fig = m.plot(forecast)
        # fig.show()

        forecast[['ds', 'yhat', 'yearly','trend','yhat_lower', 'yhat_upper','additive_terms']].tail()
        # data=forecast
        # data.to_excel(name)
        plt.subplot(2,1,1)
        # print( forecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']])
        # plt.figure(figsize=(8,4))
        plt.plot(forecast[:]['ds'],forecast[:][["yhat"]])
        plt.plot(data['Unnamed: 0'],data['displacement'],color='black')
        plt.plot(forecast['ds'], forecast['trend'], color='green')
        plt.plot(forecast['ds'], forecast['yearly'], color='blue')
        plt.plot(data_water.index, data_water["rainfall"])
        # plt.plot(forecast['ds'], forecast['additive_terms'], color='red')
        # plt.title('周期、趋势、预测'+name)
        plt.xlabel('time')
        plt.ylabel('displacement/mm')
        plt.legend(['prophet','real'])
        plt.axvline(data['Unnamed: 0'][2669], color='red', linestyle='--')
        plt.grid(axis='both')  # 此参数为默认参数
        # plt.show()
        plt.subplot(2, 1, 2)
        # plt.plot(data_water.index, data_water["水位"])
        plt.plot(data_rain.index, data_rain['rainfall'])
        plt.show()
        # fig=m.plot(forecast)
        forecast.to_excel(name)
        # a = add_changepoints_to_plot(fig.gca(), m, forecast)
        # m.plot_components(forecast)
        # plt.show()



























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































